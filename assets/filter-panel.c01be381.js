import{e as V,s as m,aW as z,aQ as Q,aj as w,v as F,an as y,f as R,r as v,o as g,m as D,x as u,P as L,Q as M,h as k,n as O,j as E,w as P,B as T,p as W}from"./App.5d51c89e.js";import{I as q}from"./plus.c251cc4b.js";import{F as G,f as H,a as J}from"./filter-collapse-item.1b81ffd9.js";import{b as X,s as Y}from"./config.3c16c364.js";import"./arrow-left.2cbc4d76.js";import"./edit.7952f962.js";import"./delete.f743b2e5.js";import"./release.c93c709a.js";import"./drag.9e668770.js";const Z=V({name:"FilterPanel",components:{IconPlus:q,FilterCollapseItem:G},setup(){const s=m(void 0),n=m(null),b=m(null),o=m({visible:!1,top:"4px",from:0,to:0}),d=z(),C=Q(),{apiDataConfig:l}=w(X),{refreshData:i}=w(Y),I=F(()=>{const t=l.value.pageFilters.map(e=>e.id);return d.dataFilters.filter(e=>!t.includes(e.id)).map(e=>({value:e.id,label:e.name}))}),c=F(()=>l.value.pageFilters.reduce((t,e)=>{const a=d.dataFilters.find(_=>_.id==e.id);return a&&t.push(a),t},[])),r=F(()=>{const t=[...C.coms,...C.subComs],e=Object.create(null);return t.forEach(a=>{for(const _ in a.apiData)a.apiData[_].pageFilters.forEach(f=>{e[f.id]?(e[f.id].ids.push(a.id),e[f.id].names.push(a.alias)):e[f.id]={ids:[a.id],names:[a.alias]}})}),e}),p=F(()=>l.value.pageFilters.reduce((t,e)=>(t[e.id]=e.enabled,t),{})),j=t=>{l.value.pageFilters.push({id:t,enabled:!0}),i()},B=(t,e)=>{l.value.pageFilters.find(a=>a.id===t).enabled=e,i()},A=(t,e)=>{const a=t.trim();a&&e.name!==a&&(e.name=a,e.id>0&&d.updateName(e))},N=()=>{n.value||(n.value={id:0,name:"\u65B0\u5EFA\u8FC7\u6EE4\u5668",code:"return data;",origin:"return data;",projectId:0,createAt:"",updateAt:""})},S=t=>{t>0?(l.value.pageFilters=l.value.pageFilters.filter(e=>e.id!==t),i()):n.value=null},$=async t=>{if(t.id>0)await d.update(t),p.value[t.id]&&i();else{const e=await d.create(t);l.value.pageFilters.push({id:e,enabled:!0}),n.value=null,i()}},K=()=>{const{from:t,to:e}=o.value;if(t!==e){const a=l.value.pageFilters;a.splice(e,0,...a.splice(t,1)),i()}},h=(t,e,a)=>{o.value.visible=t,o.value.top=`${a.offsetTop-6}px`,t?o.value.to=e:(o.value.from=e,K())},U=()=>{h(!0,c.value.length,b.value)};return y(H,{usedFilters:r,editFilterName:A,removeFilter:S,saveFilter:$}),y(J,{enabledFilters:p,onUsedChange:B,updateIndicator:h}),{filterId:s,apiDataConfig:l,dataFilters:I,selectedFilters:c,newDataFilter:n,addPanelRef:b,dragInfo:o,selectFilter:j,addFilter:N,dragEnter:U}}});const x={class:"filter-list"},ee=u("span",{class:"datav-empty"},"\u8FC7\u6EE4\u5668\u5217\u8868\u4E3A\u7A7A\uFF0C\u8BF7\u521B\u5EFA\u540E\u4F7F\u7528",-1),te=u("div",{class:"filter-dragging-wp"},null,-1);function ae(s,n,b,o,d,C){const l=v("filter-collapse-item"),i=v("n-select"),I=v("IconPlus"),c=v("n-icon");return g(),D("div",{class:W(["filter-wp",{"--disabled":!s.apiDataConfig.config.useFilter}])},[u("div",x,[(g(!0),D(L,null,M(s.selectedFilters,(r,p)=>(g(),k(l,{key:r.id,index:p,"data-filter":r},null,8,["index","data-filter"]))),128)),s.newDataFilter?(g(),k(l,{key:0,"data-filter":s.newDataFilter,index:s.selectedFilters.length,"is-new":!0,draggable:!1,"has-feedback":!1,removable:!0},null,8,["data-filter","index"])):O("",!0),u("div",{ref:"addPanelRef",class:"add-filter",onDragenter:n[1]||(n[1]=(...r)=>s.dragEnter&&s.dragEnter(...r))},[E(i,{value:s.filterId,options:s.dataFilters,filterable:"","fallback-option":!1,placeholder:"\u6DFB\u52A0\u8FC7\u6EE4\u5668",class:"datav-new-select filter-select","onUpdate:value":s.selectFilter},{empty:P(()=>[ee]),_:1},8,["value","options","onUpdate:value"]),u("div",{class:"new-filter-btn",onClick:n[0]||(n[0]=(...r)=>s.addFilter&&s.addFilter(...r))},[E(c,{class:"icon-add"},{default:P(()=>[E(I)]),_:1})])],544)]),te,u("div",{class:"drag-indicator",style:T({display:s.dragInfo.visible?"block":"none",top:s.dragInfo.top})},null,4)],2)}const fe=R(Z,[["render",ae]]);export{fe as default};
