import{e as q,I as f,be as z,b8 as L,b9 as O,aE as y,x as m,aI as D,r as R,aq as F,o as v,f as k,h as u,L as M,O as T,s as P,p as G,j as _,w as j,n as H,q as J}from"./App.93664d39.js";import{I as Q}from"./plus.7435b342.js";import{F as W,f as X,a as Y}from"./filter-collapse-item.be5ad635.js";import{b as Z,s as x}from"./config.3c16c364.js";import"./arrow-left.aabf135e.js";import"./edit.27fd812e.js";import"./delete.f2c34d22.js";import"./release.13f57dfd.js";import"./drag.bb2d70d2.js";const ee=q({name:"FilterPanel",components:{IconPlus:Q,FilterCollapseItem:W},setup(){const s=f(void 0),n=f(null),g=f(null),o=f({visible:!1,top:"4px",from:0,to:0}),d=z(),b=L(),c=O(),{apiDataConfig:l}=y(Z),{refreshData:r}=y(x),I=m(()=>{const t=l.value.pageFilters.map(e=>e.id);return d.dataFilters.filter(e=>!t.includes(e.id)).map(e=>({value:e.id,label:e.name}))}),i=m(()=>l.value.pageFilters.reduce((t,e)=>{const a=d.dataFilters.find(C=>C.id==e.id);return a&&t.push(a),t},[])),E=m(()=>{const t=[...b.coms,...b.subComs],e=Object.create(null);return t.forEach(a=>{for(const C in a.apiData)a.apiData[C].pageFilters.forEach(p=>{e[p.id]?(e[p.id].ids.push(a.id),e[p.id].names.push(a.alias)):e[p.id]={ids:[a.id],names:[a.alias]}})}),e}),h=m(()=>l.value.pageFilters.reduce((t,e)=>(t[e.id]=e.enabled,t),{})),A=t=>{l.value.pageFilters.push({id:t,enabled:!0}),r()},B=(t,e)=>{l.value.pageFilters.find(a=>a.id===t).enabled=e,r()},S=(t,e)=>{const a=t.trim();a&&e.name!==a&&(e.name=a,e.id>0&&d.updateName(e))},N=()=>{n.value||(n.value={id:0,name:"\u65B0\u5EFA\u8FC7\u6EE4\u5668",code:"return data;",origin:"return data;",projectId:c.screen.id,createAt:"",updateAt:""})},$=t=>{t>0?(l.value.pageFilters=l.value.pageFilters.filter(e=>e.id!==t),r()):n.value=null},K=async t=>{if(t.id>0)await d.update(t),h.value[t.id]&&r();else{const e=await d.create(t);l.value.pageFilters.push({id:e,enabled:!0}),n.value=null,r()}},U=()=>{const{from:t,to:e}=o.value;if(t!==e){const a=l.value.pageFilters;a.splice(e,0,...a.splice(t,1)),r()}},w=(t,e,a)=>{o.value.visible=t,o.value.top=`${a.offsetTop-6}px`,t?o.value.to=e:(o.value.from=e,U())},V=()=>{w(!0,i.value.length,g.value)};return D(X,{usedFilters:E,editFilterName:S,removeFilter:$,saveFilter:K}),D(Y,{enabledFilters:h,onUsedChange:B,updateIndicator:w}),{filterId:s,apiDataConfig:l,dataFilters:I,selectedFilters:i,newDataFilter:n,addPanelRef:g,dragInfo:o,selectFilter:A,addFilter:N,dragEnter:V}}});const te={class:"filter-list"},ae=u("span",{class:"datav-empty"},"\u8FC7\u6EE4\u5668\u5217\u8868\u4E3A\u7A7A\uFF0C\u8BF7\u521B\u5EFA\u540E\u4F7F\u7528",-1),se=u("div",{class:"filter-dragging-wp"},null,-1);function le(s,n,g,o,d,b){const c=F("filter-collapse-item"),l=F("n-select"),r=F("IconPlus"),I=F("n-icon");return v(),k("div",{class:J(["filter-wp",{"--disabled":!s.apiDataConfig.config.useFilter}])},[u("div",te,[(v(!0),k(M,null,T(s.selectedFilters,(i,E)=>(v(),P(c,{key:i.id,index:E,"data-filter":i},null,8,["index","data-filter"]))),128)),s.newDataFilter?(v(),P(c,{key:0,"data-filter":s.newDataFilter,index:s.selectedFilters.length,"is-new":!0,draggable:!1,"has-feedback":!1,removable:!0},null,8,["data-filter","index"])):G("",!0),u("div",{ref:"addPanelRef",class:"add-filter",onDragenter:n[1]||(n[1]=(...i)=>s.dragEnter&&s.dragEnter(...i))},[_(l,{value:s.filterId,options:s.dataFilters,filterable:"","fallback-option":!1,placeholder:"\u6DFB\u52A0\u8FC7\u6EE4\u5668",class:"datav-new-select filter-select","onUpdate:value":s.selectFilter},{empty:j(()=>[ae]),_:1},8,["value","options","onUpdate:value"]),u("div",{class:"new-filter-btn",onClick:n[0]||(n[0]=(...i)=>s.addFilter&&s.addFilter(...i))},[_(I,{class:"icon-add"},{default:j(()=>[_(r)]),_:1})])],544)]),se,u("div",{class:"drag-indicator",style:H({display:s.dragInfo.visible?"block":"none",top:s.dragInfo.top})},null,4)],2)}const Fe=R(ee,[["render",le]]);export{Fe as default};
